<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Internal Medicine ICU Guide</title>

<style>
  :root{
    --bg: #0b1220;
    --panel: rgba(255,255,255,0.06);
    --panel2: rgba(255,255,255,0.085);
    --border: rgba(255,255,255,0.10);
    --text: rgba(255,255,255,0.92);
    --muted: rgba(255,255,255,0.66);
    --accent: #66b3ff;
    --accent2: rgba(102,179,255,0.18);
    --danger: #ff6b6b;
    --ok: #3ddc97;
    --shadow: 0 18px 60px rgba(0,0,0,0.45);
    --radius: 16px;
  }

  *{ box-sizing: border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:
      radial-gradient(1200px 600px at 10% 0%, rgba(102,179,255,0.12), transparent 55%),
      radial-gradient(900px 500px at 90% 10%, rgba(61,220,151,0.08), transparent 55%),
      var(--bg);
    color: var(--text);
  }

  a{ color: inherit; text-decoration: none; }
  a:hover{ text-decoration: underline; }

  .wrap{
    max-width: 1200px;
    margin: 0 auto;
    padding: 18px;
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 16px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    position: sticky;
    top: 12px;
    z-index: 10;
    backdrop-filter: blur(10px);
  }

  .brand{
    display:flex;
    flex-direction: column;
    gap: 4px;
    min-width: 240px;
  }
  .brand h1{
    font-size: 16px;
    margin: 0;
    letter-spacing: 0.2px;
  }
  .brand .sub{
    font-size: 12px;
    color: var(--muted);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.16);
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap;
  }
  .dot{
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--ok);
  }

  .layout{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap: 14px;
    margin-top: 14px;
    align-items: start;
  }

  .card{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
  }

  .sidebar{
    padding: 12px;
    position: sticky;
    top: 92px;
    max-height: calc(100vh - 110px);
    overflow: auto;
  }

  .searchRow{
    display:flex;
    gap: 8px;
    align-items:center;
    margin-bottom: 10px;
  }
  .search{
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.18);
    color: var(--text);
    outline: none;
  }
  .search::placeholder{ color: rgba(255,255,255,0.45); }

  .smallBtn{
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.18);
    color: var(--muted);
    cursor: pointer;
  }
  .smallBtn:hover{ background: rgba(255,255,255,0.07); color: var(--text); }

  .topicList{
    display:flex;
    flex-direction: column;
    gap: 8px;
  }

  .topicBtn{
    width:100%;
    text-align:left;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: rgba(0,0,0,0.10);
    color: var(--muted);
    cursor: pointer;
    transition: 120ms ease;
  }
  .topicBtn:hover{
    background: rgba(255,255,255,0.07);
    color: var(--text);
  }
  .topicBtn.active{
    border-color: rgba(102,179,255,0.35);
    background: var(--accent2);
    color: var(--text);
  }

  .topicTitle{
    font-weight: 700;
    font-size: 13px;
    margin: 0;
  }
  .topicDesc{
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
    line-height: 1.35;
  }

  .main{
    padding: 14px;
  }

  .topicHeader{
    display:flex;
    justify-content: space-between;
    gap: 10px;
    align-items: flex-start;
    padding: 14px 14px 0 14px;
  }
  .topicHeader .titleBlock{
    display:flex;
    flex-direction: column;
    gap: 4px;
  }
  .topicHeader h2{
    margin: 0;
    font-size: 18px;
    letter-spacing: 0.2px;
  }
  .topicHeader .desc{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.4;
  }

  .tabs{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 12px 14px 0 14px;
    border-top: 1px solid transparent;
  }

  .tabBtn{
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.16);
    color: var(--muted);
    cursor: pointer;
  }
  .tabBtn:hover{ color: var(--text); background: rgba(255,255,255,0.07); }
  .tabBtn.active{
    background: var(--accent2);
    border-color: rgba(102,179,255,0.35);
    color: var(--text);
  }

  .content{
    padding: 14px;
  }

  .status{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(0,0,0,0.12);
    color: var(--muted);
    font-size: 13px;
  }
  .status.error{
    border-color: rgba(255,107,107,0.35);
    color: rgba(255,255,255,0.85);
  }
  .status.error .emph{ color: var(--danger); font-weight: 700; }

  /* Markdown styling */
  .md{
    line-height: 1.6;
    font-size: 14px;
  }
  .md h1, .md h2, .md h3{
    margin: 16px 0 8px;
    line-height: 1.25;
  }
  .md h1{ font-size: 20px; }
  .md h2{ font-size: 17px; }
  .md h3{ font-size: 15px; }
  .md p{ margin: 10px 0; }
  .md ul, .md ol{ margin: 10px 0 10px 20px; }
  .md li{ margin: 6px 0; }
  .md code{
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.10);
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.95em;
  }
  .md pre{
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.10);
    padding: 12px;
    border-radius: 14px;
    overflow: auto;
  }
  .md blockquote{
    margin: 12px 0;
    padding: 10px 12px;
    border-left: 3px solid rgba(102,179,255,0.45);
    background: rgba(102,179,255,0.10);
    border-radius: 12px;
    color: rgba(255,255,255,0.85);
  }
  .md hr{
    border: none;
    border-top: 1px solid rgba(255,255,255,0.10);
    margin: 16px 0;
  }

  /* Mobile */
  @media (max-width: 980px){
    .layout{ grid-template-columns: 1fr; }
    .sidebar{ position: relative; top: 0; max-height: none; }
    .topbar{ position: relative; top: 0; }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar card">
      <div class="brand">
        <h1>Internal Medicine ICU Guide</h1>
        <div class="sub">Markdown-driven resident reference</div>
      </div>

      <div class="pill" id="metaPill" title="Data source">
        <span class="dot" id="statusDot"></span>
        <span id="metaText">Loading topics…</span>
      </div>
    </div>

    <div class="layout">
      <div class="card sidebar">
        <div class="searchRow">
          <input id="searchInput" class="search" placeholder="Search topics (e.g., DKA, ARDS)" />
          <button class="smallBtn" id="clearBtn" title="Clear search">×</button>
        </div>
        <div class="topicList" id="topicList"></div>
      </div>

      <div class="card">
        <div class="topicHeader">
          <div class="titleBlock">
            <h2 id="topicTitle">Select a topic</h2>
            <div class="desc" id="topicDesc">Topics come from <code>content/index.json</code>.</div>
          </div>
          <div class="pill" id="tabPill" title="Current tab">
            <span style="width:8px;height:8px;border-radius:50%;background:var(--accent)"></span>
            <span id="tabText">quick</span>
          </div>
        </div>

        <div class="tabs">
          <button class="tabBtn active" data-tab="quick">5-Min Quick Learn</button>
          <button class="tabBtn" data-tab="deep">In-Depth</button>
          <button class="tabBtn" data-tab="sources">Sources</button>
        </div>

        <div class="content">
          <div id="contentArea" class="status">Choose a topic from the left.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ------- Config -------
    const TOPIC_INDEX_PATH = "content/index.json";
    const DEFAULT_TAB = "quick";

    // ------- State -------
    let allTopics = [];
    let filteredTopics = [];
    let currentTopic = null;
    let currentTab = DEFAULT_TAB;

    // ------- Elements -------
    const topicListEl = document.getElementById("topicList");
    const searchInputEl = document.getElementById("searchInput");
    const clearBtnEl = document.getElementById("clearBtn");

    const metaTextEl = document.getElementById("metaText");
    const statusDotEl = document.getElementById("statusDot");

    const topicTitleEl = document.getElementById("topicTitle");
    const topicDescEl = document.getElementById("topicDesc");
    const tabTextEl = document.getElementById("tabText");

    const contentAreaEl = document.getElementById("contentArea");

    // ------- Helpers -------
    function setStatus(ok, text){
      statusDotEl.style.background = ok ? "var(--ok)" : "var(--danger)";
      metaTextEl.textContent = text;
    }

    function normalize(s){
      return (s || "").toString().toLowerCase().trim();
    }

    function renderTopics(){
      topicListEl.innerHTML = "";

      if (filteredTopics.length === 0){
        const empty = document.createElement("div");
        empty.className = "status";
        empty.textContent = "No topics match your search.";
        topicListEl.appendChild(empty);
        return;
      }

      filteredTopics.forEach((t) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "topicBtn";
        btn.dataset.slug = t.slug;

        const title = document.createElement("div");
        title.className = "topicTitle";
        title.textContent = t.title || t.slug;

        btn.appendChild(title);

        if (t.description){
          const desc = document.createElement("div");
          desc.className = "topicDesc";
          desc.textContent = t.description;
          btn.appendChild(desc);
        }

        btn.addEventListener("click", () => selectTopic(t.slug));
        topicListEl.appendChild(btn);
      });

      syncActiveTopicButton();
    }

    function syncActiveTopicButton(){
      const buttons = topicListEl.querySelectorAll(".topicBtn");
      buttons.forEach(b => b.classList.remove("active"));
      if (!currentTopic) return;
      const active = topicListEl.querySelector(`.topicBtn[data-slug="${CSS.escape(currentTopic.slug)}"]`);
      if (active) active.classList.add("active");
    }

    function setTab(tab){
      currentTab = tab;
      tabTextEl.textContent = tab;

      document.querySelectorAll(".tabBtn").forEach(b => {
        b.classList.toggle("active", b.dataset.tab === tab);
      });

      loadContent();
    }

    function setContentStatus(type, message){
      contentAreaEl.className = type ? `status ${type}` : "status";
      contentAreaEl.textContent = message;
    }

    async function fetchText(path){
      const res = await fetch(path, { cache: "no-cache" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${path}`);
      return await res.text();
    }

    function renderMarkdown(md){
      contentAreaEl.className = "md";
      contentAreaEl.innerHTML = marked.parse(md);
    }

    // ------- Core -------
    async function loadTopics(){
      try{
        setStatus(true, "Loading topics…");
        const raw = await fetchText(TOPIC_INDEX_PATH);
        const data = JSON.parse(raw);

        // Allow either:
        // 1) [{slug,title,description}, ...]
        // 2) {topics:[...]}
        allTopics = Array.isArray(data) ? data : (data.topics || []);
        allTopics = allTopics
          .filter(t => t && t.slug)
          .map(t => ({
            slug: String(t.slug),
            title: t.title ? String(t.title) : String(t.slug),
            description: t.description ? String(t.description) : ""
          }));

        // Default sort by title
        allTopics.sort((a,b) => (a.title || "").localeCompare(b.title || ""));

        filteredTopics = [...allTopics];
        renderTopics();

        setStatus(true, `${allTopics.length} topics loaded`);
        // Auto-select first topic
        if (allTopics.length > 0){
          selectTopic(allTopics[0].slug);
        } else {
          setContentStatus("", "No topics found. Add entries to content/index.json.");
        }
      } catch (e){
        setStatus(false, "Failed to load topics");
        setContentStatus("error",
          "Topic index not found or invalid JSON. Verify: content/index.json is published and valid."
        );
      }
    }

    async function selectTopic(slug){
      const found = allTopics.find(t => t.slug === slug);
      if (!found){
        setContentStatus("error", "Topic not found in index.json.");
        return;
      }

      currentTopic = found;
      topicTitleEl.textContent = found.title || found.slug;
      topicDescEl.textContent = found.description || "ICU resident reference";
      syncActiveTopicButton();

      // Ensure tab stays valid
      if (!["quick","deep","sources"].includes(currentTab)) currentTab = DEFAULT_TAB;
      tabTextEl.textContent = currentTab;

      setContentStatus("", "Loading content…");
      await loadContent();
    }

    async function loadContent(){
      if (!currentTopic){
        setContentStatus("", "Choose a topic from the left.");
        return;
      }

      const path = `content/${currentTopic.slug}/${currentTab}.md`;

      try{
        setContentStatus("", "Loading content…");
        const md = await fetchText(path);
        if (!md.trim()){
          setContentStatus("", "This section is empty.");
          return;
        }
        renderMarkdown(md);
      } catch (e){
        setContentStatus("error",
          `Missing content file. Expected: ${path}`
        );
      }
    }

    // ------- Events -------
    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    searchInputEl.addEventListener("input", () => {
      const q = normalize(searchInputEl.value);
      if (!q){
        filteredTopics = [...allTopics];
      } else {
        filteredTopics = allTopics.filter(t => {
          const hay = normalize(`${t.title} ${t.slug} ${t.description}`);
          return hay.includes(q);
        });
      }
      renderTopics();
    });

    clearBtnEl.addEventListener("click", () => {
      searchInputEl.value = "";
      filteredTopics = [...allTopics];
      renderTopics();
      searchInputEl.focus();
    });

    // Keyboard: Ctrl/Cmd+K focuses search
    window.addEventListener("keydown", (e) => {
      const isK = (e.key || "").toLowerCase() === "k";
      if (isK && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        searchInputEl.focus();
      }
    });

    // Init
    loadTopics();
  </script>
</body>
</html>
